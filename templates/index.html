<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClearScript AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&family=Merriweather:wght@300;400;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f9f9f9;
            /* Paper White */
            --text: #2d2d2d;
            /* Charcoal */
            --accent: #1a3c5e;
            /* Trust Blue (Deep) */
            --secondary: #3b82f6;
            /* Action Blue (Bright) */
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --font-heading: 'Merriweather', serif;
            --font-body: 'Manrope', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Typography */
        h1,
        h2,
        h3,
        .brand {
            font-family: var(--font-heading);
            font-weight: 900;
            color: var(--accent);
            text-transform: none;
            /* Sentence case is more journalistic */
            letter-spacing: -0.01em;
            margin: 0;
        }

        h1 {
            font-size: 4rem;
            line-height: 1.2;
            margin-bottom: 25px;
        }

        h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--secondary);
            display: inline-block;
            padding-bottom: 5px;
        }

        p {
            font-size: 1.15rem;
            color: #4b5563;
            max-width: 650px;
            margin-bottom: 30px;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 20px 0;
            margin-bottom: 60px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.5rem;
            color: var(--accent);
        }

        /* Hero */
        .hero {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 50px;
            padding-bottom: 60px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 60px;
        }

        .hero-text {
            flex: 1;
        }

        .upload-trigger {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .upload-trigger:hover {
            background: var(--accent);
        }

        /* Form Overlay */
        #upload-form {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            /* Light overlay */
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .form-content {
            background: white;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        }

        .label {
            display: block;
            font-family: var(--font-heading);
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        select,
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-family: var(--font-body);
            margin-bottom: 25px;
            background: #fdfdfd;
        }

        select:focus,
        input:focus {
            border-color: var(--secondary);
            outline: none;
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .med-card {
            background: white;
            border: 1px solid var(--border);
            border-top: 4px solid var(--accent);
            padding: 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .med-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .med-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: #f8fafc;
        }

        .med-name {
            font-size: 1.25rem;
            color: var(--text);
        }

        .med-details-grid {
            padding: 20px;
            display: grid;
            gap: 15px;
        }

        .detail-item .label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .detail-item .value {
            font-size: 1rem;
            font-weight: 500;
        }

        /* Loading */
        #loading {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .hero {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-mode .container,
        body.dark-mode .med-card,
        body.dark-mode .marquee-section,
        body.dark-mode .results-grid {
            background-color: #000000;
            color: #ffffff;
            border-color: #333;
        }

        body.dark-mode header {
            border-color: #ffffff;
        }

        body.dark-mode input,
        body.dark-mode select {
            border-color: #ffffff;
            color: #ffffff;
        }

        body.dark-mode .label {
            color: #ffff00;
            /* Yellow labels */
        }

        body.dark-mode .value {
            color: #ffffff;
        }

        body.dark-mode .upload-trigger {
            background: #ffffff;
            color: #000000;
        }

        body.dark-mode .brand,
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3 {
            color: #ffffff;
        }

        /* Toggle Button */
        .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--black);
            color: var(--white);
            border: 2px solid var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        body.dark-mode .theme-toggle {
            background: var(--white);
            color: var(--black);
            border-color: var(--black);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 15vw;
            }

            .hero {
                grid-template-columns: 1fr;
            }

            .hero-visual {
                height: 300px;
            }
        }

        .custom-file-upload {
            border: 2px solid var(--border);
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            background: #fdfdfd;
            font-weight: 500;
            transition: all 0.2s;
        }

        .custom-file-upload:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }
    </style>
    <script>
        function showForm() {
            document.getElementById('upload-form').style.display = 'flex';
        }
        function closeForm(e) {
            if (e.target.id === 'upload-form') {
                document.getElementById('upload-form').style.display = 'none';
            }
        }
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        function updateFileName(input) {
            const fileNameSpan = document.getElementById('file-name');
            if (input.files && input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                fileNameSpan.style.color = 'var(--text)';
                fileNameSpan.style.fontWeight = 'bold';
            } else {
                fileNameSpan.textContent = "{{ texts.no_file }}";
                fileNameSpan.style.color = '#666';
                fileNameSpan.style.fontWeight = 'normal';
            }
        }
    </script>
</head>

<body>


    <div id="loading">
        <div class="typewriter">
            <h2>{{ texts.analyzing }}</h2>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="brand">CLEARSCRIPT.</div>
            <div>{{ texts.brand_tagline }}</div>
        </header>

        <section class="hero">
            <div class="hero-text">
                <h1>{{ texts.hero_title|safe }}</h1>
                <p>{{ texts.hero_desc }}</p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="upload-trigger" onclick="showForm()">{{ texts.start_btn }}</button>
                    <button class="history-btn" onclick="showHistory()">{{ texts.my_medicines }}</button>
                </div>
            </div>
            <div id="pill-canvas"></div>

        </section>
    </div>



    <!-- Hidden Upload Form Overlay -->
    <div id="upload-form" onclick="closeForm(event)">
        <div class="form-content">
            <h2>{{ texts.upload_title }}</h2>
            <form method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                <label class="label">{{ texts.lang_label }}</label>
                <select name="language">
                    <option value="English" {% if language=='English' %}selected{% endif %}>English</option>
                    <option value="Hindi" {% if language=='Hindi' %}selected{% endif %}>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="Kannada" {% if language=='Kannada' %}selected{% endif %}>‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                    <option value="Tamil" {% if language=='Tamil' %}selected{% endif %}>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                    <option value="Telugu" {% if language=='Telugu' %}selected{% endif %}>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                    <option value="Malayalam" {% if language=='Malayalam' %}selected{% endif %}>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                </select>

                <div class="file-input-wrapper" style="margin-bottom: 25px;">
                    <label class="label">{{ texts.file_label }}</label>
                    <div class="custom-file-container" style="display: flex; gap: 10px; align-items: center;">
                        <label for="file-upload" class="custom-file-upload">
                            {{ texts.choose_file }}
                        </label>
                        <span id="file-name" style="color: #666; font-size: 0.9rem;">{{ texts.no_file }}</span>
                    </div>
                    <input id="file-upload" type="file" name="image" required accept="image/*" style="display:none;"
                        onchange="updateFileName(this)">
                </div>

                <button type="submit" class="upload-trigger" style="width:100%">{{ texts.process_btn }}</button>
            </form>
        </div>
    </div>

    <!-- History Overlay -->
    <div id="history-overlay" onclick="closeHistory(event)">
        <div class="history-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.3rem;">{{ texts.history_title }}</h2>
                <button onclick="document.getElementById('history-overlay').style.display='none'"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>
            <div id="history-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Saved Result Viewer Overlay -->
    <div id="saved-result-overlay" onclick="closeSavedResult(event)">
        <div class="history-content" style="max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.3rem;" id="saved-result-title"></h2>
                <button onclick="document.getElementById('saved-result-overlay').style.display='none'"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>
            <div id="saved-result-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Results Section (Wizard/Card Stack) -->
    {% if translated or english %}
    <div class="container" id="results" style="max-width: 600px; padding-bottom: 120px;">

        <!-- Header / Audio Control -->
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 10px; border:none; display:block;">
                {{ texts.report_title }}</h2>

            {% if audio_path %}
            <div class="audio-control-box">
                <button onclick="document.getElementById('main-audio').play()" class="play-btn">
                    {{ texts.listen_btn }}
                </button>
                <audio id="main-audio" style="display:none">
                    <source src="{{ url_for('static', filename=audio_path) }}" type="audio/mpeg">
                </audio>
            </div>
            {% endif %}
        </div>

        <!-- Card Stack -->
        <div class="card-stack">
            {% for med in (translated if translated else english) %}
            <div class="med-card safe-card">
                <div class="med-header" style="background: var(--accent); color: white; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">{{ texts.medicine_label }} {{ loop.index }}</div>
                    <div class="med-name" style="color: white; font-size: 1.5rem; font-weight: 700;">{{
                        med.medicine_name }}</div>
                </div>

                <div class="med-details-grid">
                    <!-- Dosage (Big & Visual) -->
                    <div class="full-width" style="text-align: center; padding: 20px 0; border-bottom: 1px solid #eee;">
                        <div class="label" style="font-size: 1rem; color: #666;">{{ texts.dosage_label }}</div>
                        <div class="value" style="font-size: 2.5rem; color: var(--text); font-weight: 900;">
                            {{ med.dosage }}
                        </div>
                    </div>

                    <!-- Frequency (Visual Icons) -->
                    <div class="full-width" style="padding: 10px 0;">
                        <div class="label">{{ texts.frequency_label }}</div>
                        <div class="value" style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            üïí {{ med.frequency }}
                        </div>
                    </div>

                    <!-- Purpose -->
                    <div class="full-width">
                        <div class="label">{{ texts.purpose_label }}</div>
                        <div class="value">{{ med.purpose }}</div>
                    </div>

                    <!-- Warning (Amber Safety) -->
                    {% if med.precautions %}
                    <div class="full-width warning-box">
                        <div style="font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            {{ texts.caution_label }}
                        </div>
                        <div>{{ med.precautions }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Medicine Schedule Section -->
        <div id="schedule-section" style="margin-top: 40px; display: none;">
            <div style="background: #eef2ff; border-radius: 16px; padding: 25px;">
                <h2 style="text-align: center; margin-bottom: 25px; color: var(--primary);">{{ texts.schedule_title }}
                </h2>

                <div id="schedule-morning" class="time-slot-card morning-slot" style="display:none">
                    <div class="slot-header">
                        <span>{{ texts.morning }}</span>
                        <a href="#" onclick="setAlarm('morning')" class="alarm-link">üîî {{ texts.set_alarm }}</a>
                    </div>
                    <div class="slot-content"></div>
                </div>

                <div id="schedule-afternoon" class="time-slot-card afternoon-slot" style="display:none">
                    <div class="slot-header">
                        <span>{{ texts.afternoon }}</span>
                        <a href="#" onclick="setAlarm('afternoon')" class="alarm-link">üîî {{ texts.set_alarm }}</a>
                    </div>
                    <div class="slot-content"></div>
                </div>

                <div id="schedule-night" class="time-slot-card night-slot" style="display:none">
                    <div class="slot-header">
                        <span>{{ texts.night }}</span>
                        <a href="#" onclick="setAlarm('night')" class="alarm-link">üîî {{ texts.set_alarm }}</a>
                    </div>
                    <div class="slot-content"></div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Share (Sticky Footer) -->
        <div class="sticky-footer">
            <button onclick="showSharePicker()" class="whatsapp-btn" style="border:none; cursor:pointer;">
                <span style="font-size: 1.5rem; margin-right: 10px;">üì±</span> {{ texts.share_btn }}
            </button>
            <button class="restart-btn" onclick="window.location.href='/'">{{ texts.scan_btn }}</button>
        </div>

        <!-- Share Language Picker Modal -->
        <div id="share-picker" onclick="closeSharePicker(event)">
            <div class="history-content" style="max-width: 400px;">
                <h2 style="margin: 0 0 20px 0; font-size: 1.2rem; text-align: center;">{{ texts.share_lang_title }}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('English')">English</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Hindi')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Kannada')">‡≤ï‡≤®‡≥ç‡≤®‡≤°</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Tamil')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Telugu')">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Malayalam')">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</button>
                </div>
            </div>
        </div>

    </div>
    {% endif %}

    <style>
        /* Safety UI Overrides */
        .audio-control-box {
            background: #e0f2fe;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--secondary);
        }

        .play-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .safe-card {
            margin-bottom: 40px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08) !important;
            border: none !important;
        }

        .warning-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            color: #92400e;
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 100;
        }

        .whatsapp-btn {
            flex: 2;
            background: #25D366;
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Share Picker */
        #share-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .share-lang-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-lang-btn:hover {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        /* Schedule UI */
        .time-slot-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .slot-header {
            padding: 12px 20px;
            font-weight: 800;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .morning-slot .slot-header {
            background: #f59e0b;
        }

        /* Orange */
        .afternoon-slot .slot-header {
            background: #3b82f6;
        }

        /* Blue */
        .night-slot .slot-header {
            background: #4f46e5;
        }

        /* Indigo */

        .slot-content {
            padding: 15px 20px;
        }

        .schedule-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }

        .schedule-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .alarm-link {
            font-size: 0.8rem;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .alarm-link:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .restart-btn {
            flex: 1;
            background: #f3f4f6;
            color: var(--text);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        /* History Button */
        .history-btn {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 800;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* History Overlay */
        #history-overlay,
        #saved-result-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .history-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .history-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .history-card-date {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .history-card-meds {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .history-card-actions {
            display: flex;
            gap: 10px;
        }

        .history-card-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .view-history-btn {
            background: var(--accent);
            color: white;
        }

        .delete-history-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .no-history-msg {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 1rem;
        }

        /* Saved Result Card */
        .saved-med-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .saved-med-name {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .saved-med-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .saved-med-detail .label {
            color: #999;
            font-size: 0.85rem;
        }

        .saved-med-detail .value {
            font-weight: 600;
        }
    </style>

    <script>
        // ===== localStorage History Functions =====
        const STORAGE_KEY = 'clearscript_history';

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveToHistory(entry) {
            const history = getHistory();
            // Add to beginning (newest first)
            history.unshift(entry);
            // Keep max 20 entries
            if (history.length > 20) history.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function deleteFromHistory(index) {
            const history = getHistory();
            history.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistory(); // Re-render
        }

        function showHistory() {
            renderHistory();
            document.getElementById('history-overlay').style.display = 'flex';
        }

        function closeHistory(e) {
            if (e.target.id === 'history-overlay') {
                document.getElementById('history-overlay').style.display = 'none';
            }
        }

        function closeSavedResult(e) {
            if (e.target.id === 'saved-result-overlay') {
                document.getElementById('saved-result-overlay').style.display = 'none';
            }
        }

        function renderHistory() {
            const history = getHistory();
            const container = document.getElementById('history-list');

            if (history.length === 0) {
                container.innerHTML = '<div class="no-history-msg">{{ texts.no_history }}</div>';
                return;
            }

            let html = '';
            history.forEach((entry, index) => {
                const medNames = entry.medicines.slice(0, 3).map(m => m.name || m.medicine_name || 'Medicine').join(', ');
                const extra = entry.medicines.length > 3 ? ` +${entry.medicines.length - 3}` : '';
                html += `
                    <div class="history-card">
                        <div class="history-card-date">${entry.date} ¬∑ ${entry.language || ''}</div>
                        <div class="history-card-meds">${medNames}${extra}</div>
                        <div class="history-card-actions">
                            <button class="view-history-btn" onclick="viewSavedResult(${index})">{{ texts.view_btn }}</button>
                            <button class="delete-history-btn" onclick="deleteFromHistory(${index})">{{ texts.delete_btn }}</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function viewSavedResult(index) {
            const history = getHistory();
            const entry = history[index];
            if (!entry) return;

            document.getElementById('saved-result-title').textContent = entry.date;

            let html = '';
            entry.medicines.forEach(med => {
                html += `
                    <div class="saved-med-card">
                        <div class="saved-med-name">${med.name || med.medicine_name || 'Medicine'}</div>
                        <div class="saved-med-detail"><span class="label">{{ texts.dosage_label }}</span><span class="value">${med.dosage || '-'}</span></div>
                        <div class="saved-med-detail"><span class="label">{{ texts.frequency_label }}</span><span class="value">${med.frequency || med.timing || '-'}</span></div>
                        <div class="saved-med-detail"><span class="label">{{ texts.purpose_label }}</span><span class="value">${med.purpose || '-'}</span></div>
                        ${med.precautions ? '<div style="background:#fffbeb; border:1px solid #fcd34d; border-radius:6px; padding:10px; margin-top:8px; color:#92400e; font-size:0.85rem;">‚ö†Ô∏è ' + med.precautions + '</div>' : ''}
                    </div>
                `;
            });
            document.getElementById('saved-result-content').innerHTML = html;

            // Close history, open result viewer
            document.getElementById('history-overlay').style.display = 'none';
            document.getElementById('saved-result-overlay').style.display = 'flex';
        }

        // ===== WhatsApp Share Functions =====
        const ALL_TRANSLATIONS = {{ all_translations | tojson }};

        // Store medicine data for sharing
        {% if translated or english %}
        const SHARE_MEDICINES = {{ (translated if translated else english) | tojson }};
        const SHARE_ENGLISH = {{ english | tojson }};
        {% else %}
        const SHARE_MEDICINES = [];
        const SHARE_ENGLISH = [];
        {% endif %}

        function showSharePicker() {
            document.getElementById('share-picker').style.display = 'flex';
        }

        function closeSharePicker(e) {
            if (e.target.id === 'share-picker') {
                document.getElementById('share-picker').style.display = 'none';
            }
        }

        function shareOnWhatsApp(lang) {
            document.getElementById('share-picker').style.display = 'none';

            const t = ALL_TRANSLATIONS[lang] || ALL_TRANSLATIONS['English'];

            // Build the text summary
            let text = `üíä *${t.report_title}*\n`;
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

            const meds = SHARE_MEDICINES.length > 0 ? SHARE_MEDICINES : SHARE_ENGLISH;

            meds.forEach((med, i) => {
                const name = med.medicine_name || med.name || 'Medicine';
                const dosage = med.dosage || '-';
                const frequency = med.frequency || med.timing || '-';
                const purpose = med.purpose || '-';
                const precautions = med.precautions || '';

                text += `*${t.medicine_label} ${i + 1}: ${name}*\n`;
                text += `üìã ${t.dosage_label}: ${dosage}\n`;
                text += `üïí ${t.frequency_label}: ${frequency}\n`;
                text += `üéØ ${t.purpose_label}: ${purpose}\n`;
                if (precautions) {
                    text += `‚ö†Ô∏è ${t.caution_label}: ${precautions}\n`;
                }
                text += `\n`;
            });

            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            text += `_Shared via ClearScript AI_`;

            // Open WhatsApp with the text
            const encoded = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
        }

        // ===== Schedule Functions =====
        function parseDosage(dosageStr) {
            // Returns [Morning, Afternoon, Night] booleans
            if (!dosageStr) return [false, false, false];

            // Standard 1-0-1 format check
            const parts = dosageStr.match(/(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/);
            if (parts) {
                return [parts[1] !== '0', parts[2] !== '0', parts[3] !== '0'];
            }

            // Fallback: Keyword search
            const lower = dosageStr.toLowerCase();
            return [
                lower.includes('morn') || lower.includes('am'),
                lower.includes('after') || lower.includes('noon') || lower.includes('lunch'),
                lower.includes('night') || lower.includes('bed') || lower.includes('pm')
            ];
        }

        function renderSchedule(medicines) {
            if (!medicines || medicines.length === 0) return;

            const morningList = [];
            const afternoonList = [];
            const nightList = [];

            medicines.forEach(med => {
                const dosage = med.dosage || '';
                const [isM, isA, isN] = parseDosage(dosage);
                const name = med.medicine_name || med.name || 'Medicine';
                const timing = med.timing || med.frequency || '';

                if (isM) morningList.push({ name, timing });
                if (isA) afternoonList.push({ name, timing });
                if (isN) nightList.push({ name, timing });
            });

            // Helper to render a list into a DOM element
            const fillSlot = (id, list) => {
                const el = document.getElementById(id);
                if (list.length > 0) {
                    el.style.display = 'block';
                    el.querySelector('.slot-content').innerHTML = list.map(item => `
                        <div class="schedule-item">
                            <div style="font-weight:700; color:var(--text)">${item.name}</div>
                            <div style="font-size:0.85rem; color:#666">${item.timing}</div>
                        </div>
                    `).join('');
                }
            };

            fillSlot('schedule-morning', morningList);
            fillSlot('schedule-afternoon', afternoonList);
            fillSlot('schedule-night', nightList);

            if (morningList.length > 0 || afternoonList.length > 0 || nightList.length > 0) {
                document.getElementById('schedule-section').style.display = 'block';
            }
        }

        function setAlarm(timeOfDay) {
            // Android Intent for Clock App
            // Morning: 8 AM, Afternoon: 2 PM, Night: 9 PM
            let hour = 8;
            if (timeOfDay === 'afternoon') hour = 14;
            if (timeOfDay === 'night') hour = 21;

            const intentUrl = `intent://com.android.deskclock.action.SET_ALARM?HOUR=${hour}&MINUTES=00&SKIP_UI=true#Intent;scheme=android-app;package=com.google.android.deskclock;end`;

            // Try opening intent (works on Android)
            window.location.href = intentUrl;

            // Fallback for visual confirmation
            // alert(`üîî Setting alarm for ${timeOfDay.toUpperCase()}... \n(This works best on Android phones)`);
        }

        // ===== Auto-Save Results =====
        document.addEventListener('DOMContentLoaded', function () {
            {% if translated or english %}
            // Results exist, auto-save them
            const medicines = {{ (translated if translated else english) | tojson }};
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

        saveToHistory({
            date: dateStr,
            language: '{{ language }}',
            medicines: medicines
        });

        // ALSO RENDER SCHEDULE
        renderSchedule(medicines);
        {% endif %}
        });
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prescription AI</title>

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#991b1b">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #faf8f5;
            --text: #1a1a1a;
            --accent: #8b1a2b;
            --secondary: #a52a2a;
            --card-bg: #ffffff;
            --border: #d4c5b9;
            --font-heading: 'Merriweather', serif;
            --font-body: 'Manrope', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0 0 70px 0;
            min-height: 100vh;
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            font-size: 1rem;
        }

        /* Typography */
        h1,
        h2,
        h3,
        .brand {
            font-family: var(--font-heading);
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -0.01em;
            margin: 0;
        }

        h1 {
            font-size: 1.6rem;
            line-height: 1.3;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            border-bottom: 3px solid var(--secondary);
            display: inline-block;
            padding-bottom: 4px;
        }

        p {
            font-size: 1rem;
            color: #4b5563;
            margin-bottom: 15px;
        }

        /* Mobile-first Layout */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header {
            background: var(--card-bg);
            border-bottom: 2px solid var(--border);
            padding: 12px 0;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.3rem;
            color: var(--accent);
        }



        /* Big tappable buttons ‚Äî 48px+ height (WCAG) */
        .upload-trigger {
            display: block;
            width: 100%;
            background: var(--accent);
            color: white;
            padding: 16px 24px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            min-height: 52px;
            letter-spacing: 0.02em;
        }

        /* Upload Section ‚Äî INLINE, not a modal */
        .upload-section {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px 20px;
            margin-bottom: 20px;
        }

        .label {
            display: block;
            font-family: var(--font-heading);
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent);
            font-size: 1rem;
        }

        select,
        input[type="file"] {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 1rem;
            margin-bottom: 20px;
            background: #fdfdfd;
            min-height: 48px;
        }

        select:focus,
        input:focus {
            border-color: var(--accent);
            outline: none;
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .med-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .med-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .med-name {
            font-size: 1.3rem;
            color: var(--text);
        }

        .med-details-grid {
            padding: 16px 20px;
            display: grid;
            gap: 12px;
        }

        .detail-item .label {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .detail-item .value {
            font-size: 1.05rem;
            font-weight: 600;
        }

        /* Loading */
        #loading {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Small spinner for buttons */
        .spinner-small {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Already mobile-first, minimal overrides needed */
        @media (max-width: 768px) {
            body {
                font-size: 1rem;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-mode .container,
        body.dark-mode .med-card,
        body.dark-mode .marquee-section,
        body.dark-mode .results-grid {
            background-color: #000000;
            color: #ffffff;
            border-color: #333;
        }

        body.dark-mode header {
            border-color: #ffffff;
        }

        body.dark-mode input,
        body.dark-mode select {
            border-color: #ffffff;
            color: #ffffff;
        }

        body.dark-mode .label {
            color: #ffff00;
            /* Yellow labels */
        }

        body.dark-mode .value {
            color: #ffffff;
        }

        body.dark-mode .upload-trigger {
            background: #ffffff;
            color: #000000;
        }

        body.dark-mode .brand,
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3 {
            color: #ffffff;
        }

        /* Big tappable file buttons */
        .custom-file-upload {
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 20px;
            cursor: pointer;
            border-radius: 8px;
            background: var(--card-bg);
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
            min-height: 52px;
        }



        /* Icon + Text button pattern (research-proven for low-literacy) */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Prominent voice bar (not a hidden FAB) */
        .voice-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 8px;
            min-height: 56px;
            margin-top: 16px;
            font-family: var(--font-body);
        }

        .voice-bar svg {
            width: 24px;
            height: 24px;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 10px;
            font-size: 1rem;
            font-weight: 700;
            font-family: var(--font-body);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            cursor: pointer;
            color: #888;
            min-height: 52px;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-btn svg {
            width: 20px;
            height: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Contextual action buttons row */
        .action-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .action-row button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 10px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            font-family: var(--font-body);
            cursor: pointer;
            min-height: 52px;
            border: 2px solid;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            border-color: #25D366 !important;
        }

        .btn-ask-ai {
            background: transparent;
            color: var(--accent);
            border-color: var(--accent) !important;
        }

        /* Profile Selector */
        .profile-selector {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 20px;
            scrollbar-width: none;
        }

        /* Profile Selector */
        .profile-selector {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            flex-wrap: wrap;
            /* Allow wrapping to see all profiles */
            padding-bottom: 5px;
            margin-bottom: 20px;
            scrollbar-width: thin;
        }

        .profile-btn {
            flex: 0 0 auto;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 80px;
            position: relative;
        }

        .profile-delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: #ef444415;
            color: #ef4444;
            border-radius: 50%;
            font-size: 14px;
            margin-left: 4px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .profile-delete-btn:hover {
            background: #ef4444;
            color: white;
            opacity: 1;
        }

        .profile-btn.selected {
            background: #e0f2fe;
            border-color: var(--accent);
            color: var(--accent);
        }

        .profile-filter-chip {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }

        .profile-filter-chip.active {
            background: var(--text);
            color: white;
            border-color: var(--text);
        }

        /* Add Profile Form */
        #add-profile-form {
            display: none;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            background: #f9fafb;
            padding: 10px;
            border-radius: 12px;
            border: 1px dashed #d1d5db;
        }
    </style>
    <script>
        // Profile Management
        const ALL_TRANSLATIONS = {{ all_translations | tojson }};
        let PROFILES = JSON.parse(localStorage.getItem('clearscript_profiles')) || ['Myself', 'Father', 'Mother'];
        let CURRENT_PROFILE = localStorage.getItem('selected_profile') || 'Myself';

        // Translation Map for Standard Roles
        const PROFILE_TRANSLATIONS = {
            'Myself': '{{ texts.role_myself }}',
            'Father': '{{ texts.role_father }}',
            'Mother': '{{ texts.role_mother }}',
            'Child': '{{ texts.role_child }}',
            'Elder': '{{ texts.role_elder }}',
            'Other': '{{ texts.role_other }}'
        };

        // Ensure current profile exists in list (if deleted or legacy)
        if (!PROFILES.includes(CURRENT_PROFILE)) {
            CURRENT_PROFILE = PROFILES[0] || 'Myself';
        }

        function renderProfiles() {
            const container = document.getElementById('profile-list');
            if (!container) return;

            let html = '';
            PROFILES.forEach(p => {
                const isSelected = p === CURRENT_PROFILE ? 'selected' : '';
                const color = stringToColor(p);
                const style = isSelected ?
                    `background:${color}20; border-color:${color}; color:${color};` :
                    `border-left: 4px solid ${color};`;

                // Use translation if available, else use raw name
                const displayName = PROFILE_TRANSLATIONS[p] || p;
                const initial = displayName.charAt(0).toUpperCase();

                // Delete button (only if NOT Myself)
                // We check if the raw profile name is 'Myself' OR if the displayed name matches 'Myself' translation
                const isMyself = p === 'Myself' || displayName === '{{ texts.role_myself }}';
                const deleteHtml = isMyself ? '' :
                    `<div class="profile-delete-btn" onclick="deleteProfile(event, '${p}')">‚úï</div>`;

                html += `
                    <div class="profile-btn ${isSelected}" onclick="selectProfile('${p}')" style="${style}">
                        <span style="font-size: 1rem;">${initial}</span>
                        <span>${displayName}</span>
                        ${deleteHtml}
                    </div>
                `;
            });

            // Add '+' Button
            html += `
                <div class="profile-btn" onclick="toggleAddProfile()" style="border-style: dashed; opacity: 0.7;">
                    <span>{{ texts.role_add }}</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function selectProfile(profile) {
            CURRENT_PROFILE = profile;
            localStorage.setItem('selected_profile', profile);
            renderProfiles();
        }

        function deleteProfile(event, profile) {
            event.stopPropagation(); // Don't select when deleting

            if (confirm(`{{ texts.role_delete_confirm }} '${profile}'?`)) {
                // Remove from array
                PROFILES = PROFILES.filter(p => p !== profile);
                localStorage.setItem('clearscript_profiles', JSON.stringify(PROFILES));

                // If deleted profile was selected, switch to Myself
                if (CURRENT_PROFILE === profile) {
                    selectProfile('Myself');
                } else {
                    renderProfiles();
                }
            }
        }

        function toggleAddProfile() {
            const form = document.getElementById('add-profile-form');
            if (form.style.display === 'flex') {
                form.style.display = 'none';
            } else {
                form.style.display = 'flex';
                document.getElementById('new-profile-name').focus();
            }
        }

        function saveNewProfile() {
            const input = document.getElementById('new-profile-name');
            const name = input.value.trim();
            if (!name) return;

            if (!PROFILES.includes(name)) {
                PROFILES.push(name);
                localStorage.setItem('clearscript_profiles', JSON.stringify(PROFILES));
                selectProfile(name); // Select new profile
                input.value = '';
                toggleAddProfile();
            }
        }

        function startProfileVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice input not supported on this browser.');
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = '{{ language }}' === 'English' ? 'en-US' :
                ('{{ language }}' === 'Hindi' ? 'hi-IN' : 'en-IN');

            const btn = document.getElementById('profile-mic-btn');
            btn.style.background = '#ef4444'; // Red to indicate recording

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                // Capitalize first letter
                const formatted = transcript.charAt(0).toUpperCase() + transcript.slice(1);
                document.getElementById('new-profile-name').value = formatted;
                btn.style.background = 'var(--accent)';
                saveNewProfile(); // Auto-save on voice
            };

            recognition.onerror = function () {
                btn.style.background = 'var(--accent)';
            };

            recognition.onend = function () {
                btn.style.background = 'var(--accent)';
            };

            recognition.start();
        }

        // Consistent color generator
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function switchTab(tab) {
            // Toggle tab buttons
            document.getElementById('tab-btn-scan').classList.toggle('active', tab === 'scan');
            document.getElementById('tab-btn-history').classList.toggle('active', tab === 'history');
            // Toggle tab content
            document.getElementById('tab-scan').classList.toggle('active', tab === 'scan');
            document.getElementById('tab-history').classList.toggle('active', tab === 'history');
            // Render history when switching to history tab
            if (tab === 'history') {
                if (typeof renderHistoryInline === 'function') renderHistoryInline();
            }
        }
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // Image quality check before upload
        function checkImageAndSubmit(form) {
            const fileInput = form.querySelector('input[name="image"]');
            const cameraInput = form.querySelector('input[name="image_camera"]');
            const activeInput = (cameraInput && cameraInput.files.length > 0) ? cameraInput : fileInput;

            if (!activeInput || !activeInput.files || activeInput.files.length === 0) {
                // No file selected ‚Äî let server handle it
                showLoading();
                return true;
            }

            const file = activeInput.files[0];
            const warningEl = document.getElementById('image-quality-warning');

            // Read file and check on canvas
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Use small sample for speed
                    const sampleW = Math.min(img.width, 300);
                    const sampleH = Math.min(img.height, 300);
                    canvas.width = sampleW;
                    canvas.height = sampleH;
                    ctx.drawImage(img, 0, 0, sampleW, sampleH);

                    const imageData = ctx.getImageData(0, 0, sampleW, sampleH);
                    const pixels = imageData.data;

                    // Calculate brightness
                    let totalBrightness = 0;
                    let pixelCount = pixels.length / 4;
                    for (let i = 0; i < pixels.length; i += 4) {
                        totalBrightness += (pixels[i] * 0.299 + pixels[i + 1] * 0.587 + pixels[i + 2] * 0.114);
                    }
                    const avgBrightness = totalBrightness / pixelCount;

                    // Calculate blur (Laplacian variance)
                    let grayPixels = [];
                    for (let i = 0; i < pixels.length; i += 4) {
                        grayPixels.push(pixels[i] * 0.299 + pixels[i + 1] * 0.587 + pixels[i + 2] * 0.114);
                    }
                    let laplacianVar = 0;
                    for (let y = 1; y < sampleH - 1; y++) {
                        for (let x = 1; x < sampleW - 1; x++) {
                            const idx = y * sampleW + x;
                            const lap = -4 * grayPixels[idx] + grayPixels[idx - 1] + grayPixels[idx + 1]
                                + grayPixels[idx - sampleW] + grayPixels[idx + sampleW];
                            laplacianVar += lap * lap;
                        }
                    }
                    laplacianVar /= ((sampleW - 2) * (sampleH - 2));

                    // Thresholds
                    if (avgBrightness < 40) {
                        warningEl.textContent = '{{ texts.error_dark }}';
                        warningEl.style.display = 'block';
                        return; // Don't submit
                    }
                    if (laplacianVar < 100) {
                        warningEl.textContent = '{{ texts.error_blurry }}';
                        warningEl.style.display = 'block';
                        return; // Don't submit
                    }

                    // Quality OK ‚Äî submit
                    warningEl.style.display = 'none';
                    showLoading();
                    form.submit();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            return false; // Prevent default submit, we'll submit manually
        }

        function updateFileName(input) {
            const fileNameSpan = document.getElementById('file-name');
            // Hide quality warning when new file chosen
            const warningEl = document.getElementById('image-quality-warning');
            if (warningEl) warningEl.style.display = 'none';
            if (input.files && input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                fileNameSpan.style.color = 'var(--text)';
                fileNameSpan.style.fontWeight = 'bold';
            } else {
                fileNameSpan.textContent = "{{ texts.no_file }}";
                fileNameSpan.style.color = '#666';
                fileNameSpan.style.fontWeight = 'normal';
            }
        }
    </script>
</head>

<body>


    <div id="loading">
        <div class="typewriter">
            <h2>{{ texts.analyzing }}</h2>
        </div>
    </div>

    <div class="container" style="padding-top: 16px;">
        <header>
            <div class="brand">CLEARSCRIPT.</div>
            <div style="font-size: 0.9rem; color: #666;">{{ texts.brand_tagline }}</div>
        </header>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('scan')" id="tab-btn-scan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                    <circle cx="12" cy="13" r="4" />
                </svg>
                {{ texts.scan_btn or 'New Scan' }}
            </button>
            <button class="tab-btn" onclick="switchTab('history')" id="tab-btn-history">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                {{ texts.my_medicines or 'My History' }}
            </button>
        </div>

        <!-- TAB 1: New Scan -->
        <div class="tab-content active" id="tab-scan">
            <div class="upload-section">
                <form method="POST" enctype="multipart/form-data" onsubmit="return checkImageAndSubmit(this)">

                    <label class="label" style="margin-top: 0;">{{ texts.role_title }}</label>
                    <div class="profile-selector" id="profile-list">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Hidden Add Profile Form -->
                    <div id="add-profile-form">
                        <input type="text" id="new-profile-name" placeholder="{{ texts.role_new_placeholder }}" style="
                            flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; outline: none;
                        ">
                        <button type="button" id="profile-mic-btn" onclick="startProfileVoice()" style="
                            background: var(--accent); color: white; border: none; width: 40px; height: 40px; 
                            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
                        ">üé§</button>
                        <button type="button" onclick="saveNewProfile()" style="
                            background: #10b981; color: white; border: none; padding: 0 16px; height: 40px; 
                            border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">{{ texts.role_save }}</button>
                    </div>

                    <script>
                        // Init selection
                        document.addEventListener('DOMContentLoaded', renderProfiles);
                    </script>

                    <label class="label">{{ texts.lang_label }}</label>
                    <select name="language" style="margin-bottom: 16px;">
                        <option value="English" {% if language=='English' %}selected{% endif %}>English</option>
                        <option value="Hindi" {% if language=='Hindi' %}selected{% endif %}>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                        <option value="Kannada" {% if language=='Kannada' %}selected{% endif %}>‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                        <option value="Tamil" {% if language=='Tamil' %}selected{% endif %}>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                        <option value="Telugu" {% if language=='Telugu' %}selected{% endif %}>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                        <option value="Malayalam" {% if language=='Malayalam' %}selected{% endif %}>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                    </select>

                    <label class="label">{{ texts.file_label }}</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px;">
                        <label for="file-upload" class="custom-file-upload icon-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                            </svg>
                            {{ texts.choose_file }}
                        </label>
                        <label for="camera-upload" class="custom-file-upload icon-btn"
                            style="background: var(--accent); color: white; border-color: var(--accent);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                            {{ texts.camera_btn or 'Take Photo' }}
                        </label>
                    </div>
                    <div style="text-align: center; margin-bottom: 16px;">
                        <span id="file-name" style="color: #666; font-size: 0.95rem;">{{ texts.no_file }}</span>
                    </div>
                    <input id="file-upload" type="file" name="image" accept="image/*" style="display:none;"
                        onchange="updateFileName(this)">
                    <input id="camera-upload" type="file" name="image_camera" accept="image/*" capture="environment"
                        style="display:none;" onchange="updateFileName(this)">
                    <button type="submit" class="upload-trigger icon-btn"
                        style="justify-content: center; display: flex;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 16 12 12 8 16" />
                            <line x1="12" y1="12" x2="12" y2="21" />
                            <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" />
                        </svg>
                        {{ texts.process_btn }}
                    </button>

                    <!-- Image quality warning -->
                    <div id="image-quality-warning" style="
                        display: none;
                        background: #fff3cd;
                        border: 2px solid #ffc107;
                        border-radius: 12px;
                        padding: 14px 18px;
                        margin-top: 16px;
                        text-align: center;
                        font-size: 1.05rem;
                        font-weight: 600;
                        color: #856404;
                    "></div>

                    <!-- Manual fallback option -->
                    <div style="text-align: center; margin-top: 14px;">
                        <a href="#" onclick="event.preventDefault(); openVoiceChat();" style="
                            color: var(--accent);
                            font-size: 0.95rem;
                            text-decoration: none;
                            display: inline-flex;
                            align-items: center;
                            gap: 6px;
                        ">
                            üí¨ {{ texts.error_manual_fallback }}
                        </a>
                    </div>
                </form>

                <!-- Persistent Find Pharmacy Button -->
                <div style="margin-top: 20px; text-align: center;">
                    <a href="https://www.google.com/maps/search/pharmacy+near+me" target="_blank" style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        background: #e0f2fe;
                        color: #0369a1;
                        text-decoration: none;
                        padding: 14px;
                        border-radius: 12px;
                        font-weight: 700;
                        font-size: 1rem;
                        border: 1px solid #bae6fd;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        transition: all 0.2s;
                    ">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        {{ texts.find_pharmacy_btn }}
                    </a>
                </div>
            </div>
        </div>

        <!-- TAB 2: My History -->
        <div class="tab-content" id="tab-history">
            <!-- Filter Chips -->
            <div style="display: flex; gap: 8px; padding-bottom: 16px; overflow-x: auto; scrollbar-width: none;"
                id="history-filters">
                <!-- Populated by JS -->
            </div>

            <div id="history-list-inline">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>


    <!-- Saved Result Viewer Overlay -->
    <div id="saved-result-overlay" onclick="closeSavedResult(event)">
        <div class="history-content" style="max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.3rem;" id="saved-result-title"></h2>
                <button onclick="stopSpeech(); document.getElementById('saved-result-overlay').style.display='none'"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>

            <!-- Action Buttons -->
            <div id="saved-action-buttons" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="speakSavedResult()"
                    style="flex:1; min-width:100px; padding:12px; border-radius:8px; border:2px solid var(--accent); background:transparent; color:var(--accent); font-weight:700; cursor:pointer; min-height:48px; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
                    </svg>
                    {{ texts.listen_btn or 'Listen' }}
                </button>
                <button onclick="shareSavedResult()"
                    style="flex:1; min-width:100px; padding:12px; border-radius:8px; border:2px solid #25D366; background:transparent; color:#25D366; font-weight:700; cursor:pointer; min-height:48px; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg>
                    {{ texts.share_btn or 'Share' }}
                </button>
            </div>

            <div id="saved-result-content">
                <!-- Populated by JS -->
            </div>

            <!-- Saved Schedule Section -->
            <div id="saved-schedule-section" style="margin-top: 20px; display: none;">
                <div style="background: #eef2ff; border-radius: 12px; padding: 15px;">
                    <h3 style="text-align: center; color: var(--primary); margin-bottom: 15px;">{{ texts.schedule_title
                        }}</h3>
                    <div id="saved-schedule-morning" class="time-slot-card morning-slot" style="display:none">
                        <div class="slot-header"><span>{{ texts.morning }}</span></div>
                        <div class="slot-content"></div>
                    </div>
                    <div id="saved-schedule-afternoon" class="time-slot-card afternoon-slot" style="display:none">
                        <div class="slot-header"><span>{{ texts.afternoon }}</span></div>
                        <div class="slot-content"></div>
                    </div>
                    <div id="saved-schedule-night" class="time-slot-card night-slot" style="display:none">
                        <div class="slot-header"><span>{{ texts.night }}</span></div>
                        <div class="slot-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Recovery Section -->
    {% if error_type %}
    <div class="container" style="max-width: 600px; padding-bottom: 40px;">
        <div style="
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 16px;
            padding: 28px 24px;
            text-align: center;
            margin-top: 20px;
        ">
            <div style="font-size: 3rem; margin-bottom: 12px;">üòî</div>
            <div style="
                font-family: var(--font-heading);
                font-size: 1.15rem;
                font-weight: 700;
                color: #dc2626;
                margin-bottom: 16px;
                line-height: 1.5;
            ">{{ texts.error_read_fail }}</div>

            <!-- Retry Button -->
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'}); switchTab('scan');" style="
                background: var(--accent);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 16px 32px;
                font-size: 1.1rem;
                font-weight: 700;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 16px;
                min-height: 56px;
                font-family: var(--font-heading);
            ">üîÑ {{ texts.error_retry }}</button>

            <div style="margin-top: 8px;">
                <a href="#" onclick="event.preventDefault(); openVoiceChat();" style="
                    color: var(--accent);
                    font-size: 1rem;
                    text-decoration: none;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                ">üí¨ {{ texts.error_manual_fallback }}</a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Results Section (Wizard/Card Stack) -->
    {% if translated or english %}
    <div class="container" id="results" style="max-width: 600px; padding-bottom: 120px;">

        <!-- Header / Audio Control -->
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="font-size: 1.5rem; color: var(--text); margin-bottom: 10px; border:none; display:block;">
                {{ texts.report_title }}</h2>

            {% if audio_path %}
            <div class="audio-control-box">
                <button onclick="document.getElementById('main-audio').play()" class="play-btn icon-btn"
                    style="display:inline-flex;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
                    </svg>
                    {{ texts.listen_btn }}
                </button>
                <audio id="main-audio" style="display:none">
                    <source src="{{ url_for('static', filename=audio_path) }}" type="audio/mpeg">
                </audio>
            </div>
            {% endif %}
        </div>

        <!-- ‚ö†Ô∏è Dangerous Drug Interactions -->
        {% if dangerous_combinations and dangerous_combinations|length > 0 %}
        <div class="interaction-warnings" style="margin-bottom: 30px;">
            <div style="
                background: #fef2f2;
                border: 2px solid #dc2626;
                border-radius: 12px;
                padding: 16px 20px;
                margin-bottom: 12px;
            ">
                <div
                    style="font-family: var(--font-heading); font-weight: 900; color: #dc2626; font-size: 1.15rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                        <line x1="12" y1="9" x2="12" y2="13" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    {{ texts.interaction_title or '‚ö†Ô∏è Dangerous Combinations' }}
                </div>

                {% for combo in dangerous_combinations %}
                <div style="
                    background: {{ '#fee2e2' if combo.severity == 'high' else '#fffbeb' }};
                    border-left: 4px solid {{ '#dc2626' if combo.severity == 'high' else '#f59e0b' }};
                    border-radius: 8px;
                    padding: 14px 16px;
                    margin-bottom: 10px;
                ">
                    <div
                        style="font-weight: 800; font-size: 1.05rem; color: {{ '#991b1b' if combo.severity == 'high' else '#92400e' }}; margin-bottom: 6px;">
                        {{ 'üö®' if combo.severity == 'high' else '‚ö†Ô∏è' }} {{ combo.medicines }}
                    </div>
                    <div
                        style="font-size: 1rem; color: {{ '#991b1b' if combo.severity == 'high' else '#92400e' }}; line-height: 1.5;">
                        {{ combo.risk_translated or combo.risk }}
                    </div>
                </div>
                {% endfor %}

                <div style="font-size: 0.9rem; color: #991b1b; font-weight: 600; margin-top: 8px; text-align: center;">
                    {{ texts.interaction_advice or 'üë®‚Äç‚öïÔ∏è Please consult your doctor about these combinations' }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Card Stack -->
        <div class="card-stack">
            {% for med in (translated if translated else english) %}
            <div class="med-card safe-card">
                <div class="med-header" style="background: var(--accent); color: white; padding: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">{{ texts.medicine_label }} {{ loop.index }}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="med-name" style="color: white; font-size: 1.5rem; font-weight: 700;">{{ med.name or
                            med.medicine_name or 'Medicine' }}</div>
                        <button
                            onclick="speakMedicine('{{ (med.name or med.medicine_name or 'Medicine') | replace('\'', '\\\'') }}', '{{ (med.dosage or '') | replace('\'', '\\\'') }}', '{{ (med.purpose or '') | replace('\'', '\\\'') }}', '{{ (med.timing or med.frequency or '') | replace('\'', '\\\'') }}', this)"
                            style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                            üîä
                        </button>
                    </div>
                </div>

                <div class="med-details-grid">
                    <!-- Generic Alternative (Cost Savings) -->
                    {% if med.generic_alternative %}
                    <div class="full-width"
                        style="padding: 15px; background-color: #f0fdf4; border-bottom: 1px solid #eee;">
                        <div class="label" style="color: #166534;">{{ texts.generic_label }}</div>
                        <div class="value" style="font-size: 1.2rem; color: #15803d; font-weight: 700;">
                            {{ med.generic_alternative }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Dosage (Big & Visual) -->
                    <div class="full-width" style="text-align: center; padding: 20px 0; border-bottom: 1px solid #eee;">
                        <div class="label" style="font-size: 1rem; color: #666;">{{ texts.dosage_label }}</div>
                        <div class="value" style="font-size: 2.5rem; color: var(--text); font-weight: 900;">
                            {{ med.dosage }}
                        </div>
                    </div>

                    <!-- Frequency (Visual Icons) -->
                    <div class="full-width" style="padding: 10px 0;">
                        <div class="label">{{ texts.frequency_label }}</div>
                        <div class="value" style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            {{ med.frequency }}
                        </div>
                    </div>

                    <!-- Duration -->
                    {% if med.duration %}
                    <div class="full-width" style="padding: 10px 0;">
                        <div class="label">{{ texts.duration_label }}</div>
                        <div class="value" style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                <line x1="16" y1="2" x2="16" y2="6" />
                                <line x1="8" y1="2" x2="8" y2="6" />
                                <line x1="3" y1="10" x2="21" y2="10" />
                            </svg>
                            {{ med.duration }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Purpose -->
                    <div class="full-width">
                        <div class="label">{{ texts.purpose_label }}</div>
                        <div class="value">{{ med.purpose }}</div>
                    </div>

                    <!-- Warning (Amber Safety) -->
                    {% if med.precautions %}
                    <div class="full-width warning-box">
                        <div style="font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            {{ texts.caution_label }}
                        </div>
                        <div>{{ med.precautions }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Medicine Schedule Section -->
        <div id="schedule-section" style="margin-top: 40px; display: none;">
            <div style="background: #eef2ff; border-radius: 16px; padding: 25px;">
                <h2 style="text-align: center; margin-bottom: 25px; color: var(--accent);">{{ texts.schedule_title }}
                </h2>

                <div id="schedule-container"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div id="schedule-morning" class="time-slot-card morning-slot" style="display:none">
                        <div class="slot-header">
                            <span>{{ texts.morning }}</span>
                            <button type="button" onclick="setAlarm('morning')" class="alarm-link">üîî {{ texts.set_alarm }}</button>
                        </div>
                        <div class="slot-content"></div>
                    </div>

                    <div id="schedule-afternoon" class="time-slot-card afternoon-slot" style="display:none">
                        <div class="slot-header">
                            <span>{{ texts.afternoon }}</span>
                            <button type="button" onclick="setAlarm('afternoon')" class="alarm-link">üîî {{ texts.set_alarm }}</button>
                        </div>
                        <div class="slot-content"></div>
                    </div>

                    <div id="schedule-night" class="time-slot-card night-slot" style="display:none">
                        <div class="slot-header">
                            <span>{{ texts.night }}</span>
                            <button type="button" onclick="setAlarm('night')" class="alarm-link">üîî {{ texts.set_alarm }}</button>
                        </div>
                        <div class="slot-content"></div>
                    </div>
                </div>

                <div
                    style="text-align: center; margin-top: 20px; display: flex; font-size: 0.9rem; flex-wrap: wrap; justify-content: center; gap: 10px;">
                    <button onclick="showSharePicker('schedule')"
                        style="background:white; border:1px solid var(--accent); color:var(--accent); padding:10px 20px; border-radius:30px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        {{ texts.share_short }}
                    </button>
                    <a href="https://www.google.com/maps/search/pharmacy+near+me" target="_blank"
                        style="background:#059669; border:none; color:white; padding:10px 20px; border-radius:30px; font-weight:700; cursor:pointer; text-decoration:none; display:flex; align-items:center; gap:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        {{ texts.find_pharmacy_btn }}
                    </a>
                </div>
            </div>
        </div>

        <!-- Contextual Actions (WhatsApp Share + Ask AI) -->
        <div class="action-row" style="margin-bottom: 20px;">
            <button class="btn-whatsapp" onclick="showSharePicker()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3" />
                    <circle cx="6" cy="12" r="3" />
                    <circle cx="18" cy="19" r="3" />
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                </svg>
                {{ texts.share_btn }}
            </button>
            <button class="btn-ask-ai" onclick="openVoiceChat()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                    <line x1="12" y1="19" x2="12" y2="23" />
                    <line x1="8" y1="23" x2="16" y2="23" />
                </svg>
                {{ texts.chat_title or 'Ask AI' }}
            </button>
        </div>

        <!-- Share Language Picker Modal -->
        <div id="share-picker" onclick="closeSharePicker(event)">
            <div class="history-content" style="max-width: 400px;">
                <h2 style="margin: 0 0 20px 0; font-size: 1.2rem; text-align: center;">{{ texts.share_lang_title }}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('English')">English</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Hindi')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Kannada')">‡≤ï‡≤®‡≥ç‡≤®‡≤°</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Tamil')">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Telugu')">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
                    <button class="share-lang-btn" onclick="shareOnWhatsApp('Malayalam')">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</button>
                </div>
            </div>
        </div>

    </div>
    {% endif %}

    <style>
        /* Safety UI Overrides */
        .audio-control-box {
            background: #e0f2fe;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--secondary);
        }

        .play-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .safe-card {
            margin-bottom: 40px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08) !important;
            border: none !important;
        }

        .warning-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            color: #92400e;
        }



        /* Share Picker */
        #share-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .share-lang-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-lang-btn:active {
            background: #25D366;
            color: white;
            border-color: #25D366;
        }

        /* Schedule UI */
        .time-slot-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .slot-header {
            padding: 12px 20px;
            font-weight: 800;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .morning-slot .slot-header {
            background: #f59e0b;
        }

        /* Orange */
        .afternoon-slot .slot-header {
            background: #3b82f6;
        }

        /* Blue */
        .night-slot .slot-header {
            background: #4f46e5;
        }

        /* Indigo */

        .slot-content {
            padding: 15px 20px;
        }

        .schedule-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }

        .schedule-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .alarm-link {
            font-size: 0.8rem;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .alarm-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .alarm-link:active {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Saved Result Overlay */
        #saved-result-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .history-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .history-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent);
        }

        .history-card-date {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .history-card-meds {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .history-card-actions {
            display: flex;
            gap: 10px;
        }

        .history-card-actions button {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .view-history-btn {
            background: var(--accent);
            color: white;
        }

        .delete-history-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        .no-history-msg {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 1rem;
        }

        /* Saved Result Card */
        .saved-med-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .saved-med-name {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .saved-med-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .saved-med-detail .label {
            color: #999;
            font-size: 0.85rem;
        }

        .saved-med-detail .value {
            font-weight: 600;
        }
    </style>

    <script>
        // ===== localStorage History Functions =====
        const STORAGE_KEY = 'clearscript_history';

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveToHistory(entry) {
            const history = getHistory();
            // Add to beginning (newest first)
            history.unshift(entry);
            // Keep max 20 entries
            if (history.length > 20) history.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function deleteFromHistory(index) {
            const history = getHistory();
            history.splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistoryInline(); // Re-render
        }

        function showHistory() {
            switchTab('history');
        }

        function closeHistory(e) {
            // No-op: history is now inline in a tab
        }

        function closeSavedResult(e) {
            if (e.target.id === 'saved-result-overlay') {
                document.getElementById('saved-result-overlay').style.display = 'none';
            }
        }

        let currentHistoryFilter = 'All';

        function filterHistory(profile) {
            currentHistoryFilter = profile;
            renderHistoryInline(); // Re-render logic handles chips
        }

        function renderHistoryInline() {
            const history = getHistory();
            const container = document.getElementById('history-list-inline');
            const filterContainer = document.getElementById('history-filters');

            if (!container) return;

            // 1. Render Filters
            if (filterContainer) {
                // Collect all unique profiles from history + active profiles
                const usedProfiles = new Set(PROFILES); // Start with saved profiles
                history.forEach(h => usedProfiles.add(h.profile || 'Myself'));

                let filterHtml = `<div class="profile-filter-chip ${currentHistoryFilter === 'All' ? 'active' : ''}" onclick="filterHistory('All')">{{ texts.filter_all }}</div>`;

                Array.from(usedProfiles).sort().forEach(p => {
                    const isActive = currentHistoryFilter === p ? 'active' : '';
                    const displayName = PROFILE_TRANSLATIONS[p] || p;
                    filterHtml += `<div class="profile-filter-chip ${isActive}" onclick="filterHistory('${p}')">${displayName}</div>`;
                });
                filterContainer.innerHTML = filterHtml;
            }

            if (history.length === 0) {
                container.innerHTML = '<div class="no-history-msg">{{ texts.no_history }}</div>';
                return;
            }

            // 2. Filter history
            const filtered = currentHistoryFilter === 'All'
                ? history
                : history.filter(h => (h.profile || 'Myself') === currentHistoryFilter);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-history-msg" style="padding:20px;">No records found for this profile.</div>';
                return;
            }

            let html = '';
            filtered.forEach((entry, index) => {
                // Determine original index in full history for actions
                const originalIndex = history.indexOf(entry);

                const medNames = entry.medicines.slice(0, 3).map(m => m.name || m.medicine_name || 'Medicine').join(', ');
                const extra = entry.medicines.length > 3 ? ` +${entry.medicines.length - 3}` : '';

                const profileKey = entry.profile || 'Myself';
                const profileDisplay = PROFILE_TRANSLATIONS[profileKey] || profileKey;
                const color = stringToColor(profileKey);

                html += `
                    <div class="history-card" style="border-left-color: ${color};">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <div class="history-card-date">${entry.date} ¬∑ ${entry.language || ''}</div>
                            <div style="font-size:0.75rem; background:${color}20; color:${color}; padding:2px 8px; border-radius:10px; font-weight:700;">${profileDisplay}</div>
                        </div>
                        <div class="history-card-meds">${medNames}${extra}</div>
                        <div class="history-card-actions">
                            <button class="view-history-btn" onclick="viewSavedResult(${originalIndex})">{{ texts.view_btn }}</button>
                            <button style="padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-weight:600; font-size:0.85rem; background:#25D366; color:white;" onclick="shareHistoryItem(${originalIndex})">{{ texts.share_btn or 'Share' }}</button>
                            <button class="delete-history-btn" onclick="deleteFromHistory(${originalIndex})">{{ texts.delete_btn }}</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Share a specific history item
        function shareHistoryItem(index) {
            const history = getHistory();
            const entry = history[index];
            if (!entry) return;
            window._origShareMeds = SHARE_MEDICINES;
            SHARE_MEDICINES = entry.medicines;
            showSharePicker('report');
            setTimeout(() => { SHARE_MEDICINES = window._origShareMeds || []; }, 5000);
        }

        function viewSavedResult(index) {
            const history = getHistory();
            const entry = history[index];
            if (!entry) return;

            // Store for sharing
            window._savedViewMeds = entry.medicines;

            document.getElementById('saved-result-title').textContent = entry.date;

            let html = '';
            entry.medicines.forEach(med => {
                html += `
                    <div class="saved-med-card">
                        <div class="saved-med-name" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>${med.name || med.medicine_name || 'Medicine'}</span>
                            <button onclick="speakMedicine('${(med.name || '').replace(/'/g, "\\'")}', '${(med.dosage || '').replace(/'/g, "\\'")}', '${(med.purpose || '').replace(/'/g, "\\'")}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üîä</button>
                        </div>
                        ${med.generic_alternative ? `
                        <div class="saved-med-detail" style="background:#f0fdf4; padding:8px; border-radius:4px; border:1px solid #bbf7d0; margin-top:5px;">
                            <span class="label" style="color:#166534;">{{ texts.generic_label }}</span>
                            <span class="value" style="color:#15803d; font-weight:700;">${med.generic_alternative}</span>
                        </div>` : ''}
                        <div class="saved-med-detail">
                            <span class="label">{{ texts.dosage_label }}</span>
                            <span class="value">${med.dosage || '-'}</span>
                             ${renderDosageIcons(med.dosage)}
                        </div>
                        <div class="saved-med-detail"><span class="label">{{ texts.frequency_label }}</span><span class="value">${med.frequency || med.timing || '-'}</span></div>
                        <div class="saved-med-detail"><span class="label">{{ texts.purpose_label }}</span><span class="value">${med.purpose || '-'}</span></div>
                        ${med.precautions ? '<div style="background:#fffbeb; border:1px solid #fcd34d; border-radius:6px; padding:10px; margin-top:8px; color:#92400e; font-size:0.85rem;">' + med.precautions + '</div>' : ''}
                    </div>
                `;
            });
            document.getElementById('saved-result-content').innerHTML = html;

            // Render schedule for saved result
            renderSavedSchedule(entry.medicines);

            // Open result viewer (history is inline, no need to close it)
            document.getElementById('saved-result-overlay').style.display = 'flex';
        }

        // ===== Web Speech API for Saved Results =====
        let currentUtterance = null;

        function speakSavedResult() {
            if (!window._savedViewMeds || window._savedViewMeds.length === 0) return;

            // Stop any ongoing speech
            stopSpeech();

            let text = '{{ texts.report_title }}. ';
            window._savedViewMeds.forEach(med => {
                const name = med.name || med.medicine_name || 'Medicine';
                const purpose = med.purpose || '';
                const dosage = med.dosage || '';
                const timing = med.frequency || med.timing || '';

                const naturalDosage = naturalDosageText(dosage);

                text += `${name}. `;
                if (naturalDosage) text += `${naturalDosage}. `;
                else if (dosage) text += `{{ texts.dosage_label }}: ${dosage}. `;

                if (timing && !naturalDosage) text += `{{ texts.frequency_label }}: ${timing}. `;
                if (purpose) text += `{{ texts.purpose_label }}: ${purpose}. `;
                if (med.precautions) text += `{{ texts.caution_label }}: ${med.precautions}. `;
            });

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;

            // Voice Selection Logic
            const targetLang = SPEECH_LANG_MAP['{{ language }}'] || 'en-IN';
            currentUtterance.lang = targetLang;

            const preferredVoice = getVoiceForLang(targetLang);
            if (preferredVoice) currentUtterance.voice = preferredVoice;

            speechSynthesis.speak(currentUtterance);
        }

        function shareSavedResult() {
            if (!window._savedViewMeds) return;
            // Temporarily override share data
            window._origShareMeds = SHARE_MEDICINES;
            SHARE_MEDICINES = window._savedViewMeds;
            showSharePicker('report');
            // Restore after a delay
            setTimeout(() => { SHARE_MEDICINES = window._origShareMeds || []; }, 5000);
        }

        function renderSavedSchedule(medicines) {
            if (!medicines || medicines.length === 0) return;

            const morningList = [], afternoonList = [], nightList = [];
            medicines.forEach(med => {
                const dosage = med.dosage || '';
                const [isM, isA, isN] = parseDosage(dosage);
                const name = med.medicine_name || med.name || 'Medicine';
                const timing = med.timing || med.frequency || '';

                if (isM) morningList.push({ name, timing, dosage: med.dosage });
                if (isA) afternoonList.push({ name, timing, dosage: med.dosage });
                if (isN) nightList.push({ name, timing, dosage: med.dosage });
            });

            const fillSlot = (id, list) => {
                const el = document.getElementById(id);
                if (list.length > 0) {
                    el.style.display = 'block';
                    el.querySelector('.slot-content').innerHTML = list.map(item => `
                        <div class="schedule-item">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div style="font-weight:700; color:var(--text)">${item.name}</div>
                                <button onclick="speakMedicine('${item.name.replace(/'/g, "\\'")}', '${(item.dosage || '').replace(/'/g, "\\'")}', '', this)" style="background:none; border:none; cursor:pointer; opacity:0.6;">üîä</button>
                            </div>
                            <div style="font-size:0.85rem; color:#666">${item.timing}</div>
                            ${renderDosageIcons(item.dosage)}
                        </div>
                    `).join('');
                } else {
                    el.style.display = 'none';
                }
            };

            fillSlot('saved-schedule-morning', morningList);
            fillSlot('saved-schedule-afternoon', afternoonList);
            fillSlot('saved-schedule-night', nightList);

            if (morningList.length > 0 || afternoonList.length > 0 || nightList.length > 0) {
                document.getElementById('saved-schedule-section').style.display = 'block';
            } else {
                document.getElementById('saved-schedule-section').style.display = 'none';
            }
        }

        // ===== WhatsApp Share Functions =====
        let currentShareMode = 'report'; // 'report' or 'schedule'

        // Store medicine data for sharing
        {% if translated or english %}
        var SHARE_MEDICINES = {{ (translated if translated else english) | tojson }};
        var SHARE_ENGLISH = {{ english | tojson }};
        {% else %}
        var SHARE_MEDICINES = [];
        var SHARE_ENGLISH = [];
        {% endif %}

        function showSharePicker(mode = 'report') {
            currentShareMode = mode;
            const picker = document.getElementById('share-picker');
            if (!picker) {
                alert('Please scan a prescription first!');
                return;
            }
            picker.style.display = 'flex';
        }

        function closeSharePicker(e) {
            if (e.target.id === 'share-picker') {
                document.getElementById('share-picker').style.display = 'none';
            }
        }

        function shareOnWhatsApp(lang) {
            document.getElementById('share-picker').style.display = 'none';

            const t = ALL_TRANSLATIONS[lang] || ALL_TRANSLATIONS['English'];
            let text = '';

            if (currentShareMode === 'schedule') {
                // SCHEDULE SHARE
                text = `*${t.schedule_title}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                const meds = SHARE_MEDICINES.length > 0 ? SHARE_MEDICINES : SHARE_ENGLISH;

                const timeSlots = [
                    { name: t.morning, check: (d) => parseDosage(d)[0] },
                    { name: t.afternoon, check: (d) => parseDosage(d)[1] },
                    { name: t.night, check: (d) => parseDosage(d)[2] }
                ];

                let hasMeds = false;
                timeSlots.forEach(slot => {
                    const slotMeds = meds.filter(m => slot.check(m.dosage || ''));
                    if (slotMeds.length > 0) {
                        hasMeds = true;
                        text += `*${slot.name}*\n`;
                        slotMeds.forEach(m => {
                            text += `‚Ä¢ ${m.name || m.medicine_name || 'Medicine'}\n`;
                            text += `  _${m.timing || m.frequency || ''}_\n`;
                        });
                        text += `\n`;
                    }
                });

                if (!hasMeds) text += `No medicines scheduled.\n\n`;
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n_Shared via ClearScript AI_`;

            } else {
                // REPORT SHARE
                text = `*${t.report_title}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

                const meds = SHARE_MEDICINES.length > 0 ? SHARE_MEDICINES : SHARE_ENGLISH;

                meds.forEach((med, i) => {
                    const name = med.medicine_name || med.name || 'Medicine';
                    const dosage = med.dosage || '-';
                    const frequency = med.frequency || med.timing || '-';
                    const purpose = med.purpose || '-';
                    const precautions = med.precautions || '';
                    const generic = med.generic_alternative || '';

                    text += `*${t.medicine_label} ${i + 1}: ${name}*\n`;
                    if (generic) text += `${t.generic_label}${generic}\n`;
                    text += `${t.dosage_label}: ${dosage}\n`;
                    text += `üïí ${t.frequency_label}: ${frequency}\n`;
                    text += `${t.purpose_label}: ${purpose}\n`;
                    if (precautions) {
                        text += `${t.caution_label}: ${precautions}\n`;
                    }
                    text += `\n`;
                });

                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `_Shared via ClearScript AI_`;
            }

            // Mobile-first sharing (Web Share API)
            if (navigator.share) {
                console.log("Attempting Web Share API");
                navigator.share({
                    title: 'Prescription Guide',
                    text: text
                }).catch(err => {
                    console.error("Share API failed:", err);
                    // Fallback to direct WhatsApp link if native share fails/cancelled
                    openWhatsAppDirect(text);
                });
            } else {
                openWhatsAppDirect(text);
            }
        }

        function openWhatsAppDirect(text) {
            const encoded = encodeURIComponent(text);
            const url = `https://wa.me/?text=${encoded}`;

            // Try creating a temporary link - bypasses some blockers
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===== Visual Helpers =====
        function renderDosageIcons(dosage) {
            if (!dosage) return '';

            // Try 1-0-1 format
            const parts = dosage.match(/(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/);
            if (parts) {
                let html = '<div style="display:flex; gap:8px; margin-top:4px; font-size: 1.1rem;">';
                if (parts[1] !== '0') html += `<div title="Morning" style="display:flex; align-items:center;">‚òÄÔ∏è ${'üíä'.repeat(parseInt(parts[1]))}</div>`;
                if (parts[2] !== '0') html += `<div title="Afternoon" style="display:flex; align-items:center;">üå§Ô∏è ${'üíä'.repeat(parseInt(parts[2]))}</div>`;
                if (parts[3] !== '0') html += `<div title="Night" style="display:flex; align-items:center;">üåô ${'üíä'.repeat(parseInt(parts[3]))}</div>`;
                html += '</div>';
                return html;
            }

            // Fallback keywords
            const lower = dosage.toLowerCase();
            let icons = '';
            if (lower.includes('morn') || lower.includes('am')) icons += '‚òÄÔ∏è ';
            if (lower.includes('after') || lower.includes('noon') || lower.includes('lunch')) icons += 'üå§Ô∏è ';
            if (lower.includes('night') || lower.includes('bed') || lower.includes('pm')) icons += 'üåô ';

            return icons ? `<div style="margin-top:4px; font-size: 1.1rem;">${icons}</div>` : '';
        }

        function naturalDosageText(dosage) {
            if (!dosage) return '';
            // Use current user lang or fallback
            const lang = '{{ language }}' || 'English';
            const t = ALL_TRANSLATIONS[lang] || ALL_TRANSLATIONS['English'];

            // Try 1-0-1 format
            const parts = dosage.match(/(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/);
            if (parts) {
                let partsText = [];
                // Use new TTS keys if available, else fallback
                const tablet = t.tts_tablet || t.tablet || 'tablet';
                const take = t.tts_take || 'Take';

                if (parts[1] !== '0') partsText.push(`${parts[1]} ${tablet} ${t.tts_morning || t.morning}`);
                if (parts[2] !== '0') partsText.push(`${parts[2]} ${tablet} ${t.tts_afternoon || t.afternoon}`);
                if (parts[3] !== '0') partsText.push(`${parts[3]} ${tablet} ${t.tts_night || t.night}`);

                if (partsText.length > 0) return `${take} ${partsText.join(', ')}`;
            }
            return dosage;
        }

        // Global variables to track currently playing audio
        let currentAudio = null;
        let currentSpeakingButton = null;

        function stopSpeech() {
            // Stop medicine audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            // Stop chat audio
            if (typeof _chatAudio !== 'undefined' && _chatAudio) {
                _chatAudio.pause();
                _chatAudio.currentTime = 0;
                _chatAudio = null;
            }
            
            // Cancel any web speech synthesis
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            // Reset button if there was one
            if (currentSpeakingButton) {
                currentSpeakingButton.innerHTML = 'üîä';
                currentSpeakingButton.disabled = false;
                currentSpeakingButton = null;
            }
        }

        function speakMedicine(name, dosage, purpose, timing, btnElement) {
            // Stop any currently playing audio first
            stopSpeech();

            // Show loading state immediately
            const originalContent = btnElement ? btnElement.innerHTML : 'üîä';
            if (btnElement) {
                btnElement.innerHTML = '<span class="spinner-small"></span>';
                btnElement.disabled = true;
                currentSpeakingButton = btnElement;
            }

            // Build clean text - only essential information
            let text = `${name}. `;
            
            // Add dosage in natural language
            const naturalDosage = naturalDosageText(dosage);
            if (naturalDosage) {
                text += `${naturalDosage}. `;
            } else if (dosage) {
                text += `{{ texts.dosage_label }}: ${dosage}. `;
            }

            // Add timing information
            const lang = '{{ language }}' || 'English';
            const t = (typeof ALL_TRANSLATIONS !== 'undefined' && ALL_TRANSLATIONS[lang]) ? ALL_TRANSLATIONS[lang] : (ALL_TRANSLATIONS['English'] || {});

            if (timing) {
                const lowerTiming = timing.toLowerCase();
                if (lowerTiming.includes('after') && (lowerTiming.includes('food') || lowerTiming.includes('meal'))) {
                    text += `${t.tts_after_food}.`;
                } else if (lowerTiming.includes('before') && (lowerTiming.includes('food') || lowerTiming.includes('meal'))) {
                    text += `${t.tts_before_food}.`;
                } else {
                    text += `${timing}.`;
                }
            } else {
                const lower = (dosage || '').toLowerCase();
                if ((dosage || '').match(/(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/)) {
                    text += `${t.tts_after_food}.`;
                } else if (lower.includes('after') || lower.includes('food') || lower.includes('meal') || lower.includes('before')) {
                    // already in dosage
                } else {
                    text += `${t.tts_as_directed}.`;
                }
            }

            // Server-Side TTS Call - send only the clean text
            fetch('/speak', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    language: '{{ language }}' || 'English'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.audio_url) {
                        const audio = new Audio(data.audio_url);
                        currentAudio = audio;
                        
                        // Change to playing state
                        if (btnElement) {
                            btnElement.innerHTML = '‚è∏Ô∏è'; // Pause icon while playing
                            btnElement.disabled = false;
                        }
                        
                        audio.play();
                        
                        audio.onended = () => {
                            if (btnElement) {
                                btnElement.innerHTML = originalContent;
                                btnElement.disabled = false;
                            }
                            currentAudio = null;
                            currentSpeakingButton = null;
                        };
                        
                        audio.onerror = () => {
                            // Fallback on playback error
                            if (btnElement) {
                                btnElement.innerHTML = originalContent;
                                btnElement.disabled = false;
                            }
                            currentAudio = null;
                            currentSpeakingButton = null;
                            fallbackTTS(text, btnElement, originalContent);
                        };
                    } else {
                        fallbackTTS(text, btnElement, originalContent);
                    }
                })
                .catch(err => {
                    console.error("TTS Error:", err);
                    if (btnElement) {
                        btnElement.innerHTML = originalContent;
                        btnElement.disabled = false;
                    }
                    currentAudio = null;
                    currentSpeakingButton = null;
                    fallbackTTS(text, btnElement, originalContent);
                });
        }

        function fallbackTTS(text, btnElement, originalContent) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = getLangCode('{{ language }}');
            
            if (btnElement) {
                btnElement.innerHTML = '‚è∏Ô∏è';
                btnElement.disabled = false;
            }
            
            window.speechSynthesis.speak(utterance);
            
            utterance.onend = () => {
                if (btnElement) {
                    btnElement.innerHTML = originalContent;
                    btnElement.disabled = false;
                }
                currentSpeakingButton = null;
            };
            
            utterance.onerror = () => {
                if (btnElement) {
                    btnElement.innerHTML = originalContent;
                    btnElement.disabled = false;
                }
                currentSpeakingButton = null;
            };
        }

        // ===== Schedule Functions =====
        function parseDosage(dosageStr) {
            // Returns [Morning, Afternoon, Night] booleans
            if (!dosageStr) return [false, false, false];

            // Standard 1-0-1 format check
            const parts = dosageStr.match(/(\d+)\s*-\s*(\d+)\s*-\s*(\d+)/);
            if (parts) {
                return [parts[1] !== '0', parts[2] !== '0', parts[3] !== '0'];
            }

            // Fallback: Keyword search
            const lower = dosageStr.toLowerCase();
            return [
                lower.includes('morn') || lower.includes('am'),
                lower.includes('after') || lower.includes('noon') || lower.includes('lunch'),
                lower.includes('night') || lower.includes('bed') || lower.includes('pm')
            ];
        }

        function renderSchedule(medicines) {
            if (!medicines || medicines.length === 0) return;

            const morningList = [];
            const afternoonList = [];
            const nightList = [];

            medicines.forEach(med => {
                const dosage = med.dosage || '';
                const [isM, isA, isN] = parseDosage(dosage);
                const name = med.medicine_name || med.name || 'Medicine';
                const timing = med.timing || med.frequency || '';

                if (isM) morningList.push({ name, timing, dosage: med.dosage });
                if (isA) afternoonList.push({ name, timing, dosage: med.dosage });
                if (isN) nightList.push({ name, timing, dosage: med.dosage });
            });

            // Helper to render a list into a DOM element
            const fillSlot = (id, list) => {
                const el = document.getElementById(id);
                if (list.length > 0) {
                    el.style.display = 'block';
                    el.querySelector('.slot-content').innerHTML = list.map(item => `
                        <div class="schedule-item">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div style="font-weight:700; color:var(--text)">${item.name}</div>
                                <button onclick="speakMedicine('${item.name.replace(/'/g, "\\'")}', '${(item.dosage || '').replace(/'/g, "\\'")}', '', '${(item.timing || '').replace(/'/g, "\\'")}', this)" style="background:none; border:none; cursor:pointer; opacity:0.6;">üîä</button>
                            </div>
                            <div style="font-size:0.85rem; color:#666">${item.timing}</div>
                            ${renderDosageIcons(item.dosage)}
                        </div>
                    `).join('');
                }
            };

            fillSlot('schedule-morning', morningList);
            fillSlot('schedule-afternoon', afternoonList);
            fillSlot('schedule-night', nightList);

            if (morningList.length > 0 || afternoonList.length > 0 || nightList.length > 0) {
                document.getElementById('schedule-section').style.display = 'block';
            }
        }





        function setAlarm(type) {
            // Get medicines for this time slot
            const medicines = getMedicinesForTimeSlot(type);
            
            if (!medicines || medicines.length === 0) {
                alert("{{ texts.no_medicines_for_slot or 'No medicines scheduled for this time' }}");
                return;
            }
            
            // Build alarm label with medicine names in selected language
            const lang = '{{ language }}' || 'English';
            let alarmLabel = '';
            
            if (type === 'morning') {
                alarmLabel = '{{ texts.morning or "Morning" }} - ';
            } else if (type === 'afternoon') {
                alarmLabel = '{{ texts.afternoon or "Afternoon" }} - ';
            } else if (type === 'night') {
                alarmLabel = '{{ texts.night or "Night" }} - ';
            }
            
            // Add medicine names (max 3 to keep label short)
            const medicineNames = medicines.slice(0, 3).map(m => m.name || m.medicine_name).join(', ');
            alarmLabel += medicineNames;
            if (medicines.length > 3) {
                alarmLabel += ` +${medicines.length - 3} more`;
            }
            
            console.log('Alarm label:', alarmLabel);
            
            // Set default times
            let hour = 8, minute = 0;
            if (type === 'morning') {
                hour = 8; minute = 0;
            } else if (type === 'afternoon') {
                hour = 13; minute = 0;
            } else if (type === 'night') {
                hour = 21; minute = 0;
            }
            
            // Detect mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            console.log('Is mobile:', isMobile, 'User agent:', navigator.userAgent);
            
            if (isMobile) {
                // Mobile: Try to open native clock app
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                
                if (isIOS) {
                    // iOS: Use clock-alarm:// URL scheme
                    const message = `{{ texts.alarm_ios_instructions or "Please set an alarm for" }} ${hour}:${minute < 10 ? '0' + minute : minute}\n\n{{ texts.alarm_label or "Label" }}: ${alarmLabel}`;
                    
                    if (confirm(message + '\n\n{{ texts.alarm_open_clock or "Open Clock app?" }}')) {
                        window.location.href = 'clock-alarm://';
                        setTimeout(() => {
                            showToast(`{{ texts.alarm_set_manually or "Set alarm manually for" }} ${hour}:${minute < 10 ? '0' + minute : minute}`);
                        }, 1000);
                    }
                } else if (isAndroid) {
                    // Android: Show instructions with copy-to-clipboard functionality
                    const timeStr = `${hour}:${minute < 10 ? '0' + minute : minute}`;
                    
                    // Try to open Clock app first
                    const intentUrl = `intent:#Intent;` +
                        `action=android.intent.action.SET_ALARM;` +
                        `i.android.intent.extra.alarm.HOUR=${hour};` +
                        `i.android.intent.extra.alarm.MINUTES=${minute};` +
                        `S.android.intent.extra.alarm.MESSAGE=${encodeURIComponent(alarmLabel)};` +
                        `i.android.intent.extra.alarm.SKIP_UI=false;` +
                        `end`;
                    
                    console.log('Trying intent URL:', intentUrl);
                    
                    // Create a hidden link and click it (works better than window.location)
                    const link = document.createElement('a');
                    link.href = intentUrl;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show helpful message with alarm details in user's language
                    setTimeout(() => {
                        const message = 
                            `{{ texts.alarm_instructions_title }} ${timeStr}\n\n` +
                            `{{ texts.alarm_instructions_label }} ${alarmLabel}\n\n` +
                            `{{ texts.alarm_instructions_if_not_open }}\n` +
                            `{{ texts.alarm_instructions_step1 }}\n` +
                            `{{ texts.alarm_instructions_step2 }}\n` +
                            `{{ texts.alarm_instructions_step3 }} ${timeStr}\n` +
                            `{{ texts.alarm_instructions_step4 }} ${alarmLabel}`;
                        
                        // Try to copy label to clipboard
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(alarmLabel).then(() => {
                                alert(message + '\n\n{{ texts.alarm_label_copied }}');
                            }).catch(() => {
                                alert(message);
                            });
                        } else {
                            alert(message);
                        }
                    }, 1500);
                } else {
                    alert(`{{ texts.alarm_set_manually or "Please set an alarm manually for" }} ${hour}:${minute < 10 ? '0' + minute : minute}\n\n${alarmLabel}`);
                }
            } else {
                alert(`{{ texts.alarm_desktop or "Alarm feature is for mobile devices. Please set an alarm on your phone for" }} ${hour}:${minute < 10 ? '0' + minute : minute}\n\n${alarmLabel}`);
            }
        }
        
        function getMedicinesForTimeSlot(type) {
            // Get medicines from the current results
            const medicines = {{ (translated if translated else english) | tojson | safe }};
            
            if (!medicines || !Array.isArray(medicines)) {
                return [];
            }
            
            return medicines.filter(med => {
                const dosage = (med.dosage || '').toLowerCase();
                const timing = (med.visual_timing || '').toLowerCase();
                
                if (type === 'morning') {
                    return timing.includes('‚òÄÔ∏è') || dosage.match(/^1-/) || dosage.includes('morning');
                } else if (type === 'afternoon') {
                    return timing.includes('üå§Ô∏è') || dosage.match(/-1-/) || dosage.includes('afternoon');
                } else if (type === 'night') {
                    return timing.includes('üåô') || dosage.match(/-1$/) || dosage.includes('night');
                }
                return false;
            });
        }
        
        function setAlarmNotification(type, alarmLabel, hour, minute) {
            // Fallback: Browser notification for desktop or unsupported mobile
            if (!("Notification" in window)) {
                alert("{{ texts.alarm_not_supported or 'Alarm feature not supported on this device' }}");
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    const now = new Date();
                    let targetTime = new Date();
                    targetTime.setHours(hour, minute, 0, 0);

                    // If time passed, schedule for tomorrow
                    if (targetTime < now) {
                        targetTime.setDate(targetTime.getDate() + 1);
                    }

                    const timeDiff = targetTime - now;
                    const formattedTime = targetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    showToast(`{{ texts.alarm_set_for or "Alarm set for" }} ${formattedTime}`);

                    // Create the actual system notification timer
                    setTimeout(() => {
                        playNotificationSound();

                        if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification("{{ texts.alarm_title or 'Medication Reminder' }}", {
                                    body: alarmLabel,
                                    icon: "https://cdn-icons-png.flaticon.com/512/3063/3063176.png",
                                    vibrate: [200, 100, 200],
                                    tag: 'medication-alarm-' + type
                                });
                            });
                        } else {
                            new Notification("{{ texts.alarm_title or 'Medication Reminder' }}", {
                                body: alarmLabel,
                                icon: "https://cdn-icons-png.flaticon.com/512/3063/3063176.png"
                            });
                        }
                    }, timeDiff);

                } else {
                    alert("{{ texts.alarm_permission_denied or 'Please allow notifications to set alarms' }}");
                }
            });
        }

        function playNotificationSound() {
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
            audio.play().catch(e => console.log("Audio play failed", e));
        }

        // Simple Toast Notification
        function showToast(message) {
            let toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== Auto-Save Results =====
        document.addEventListener('DOMContentLoaded', function () {
            {% if translated or english %}
            // Results exist, auto-save them
            const medicines = {{ (translated if translated else english) | tojson }};
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });

        saveToHistory({
            date: dateStr,
            language: '{{ language }}',
            medicines: medicines,
            profile: localStorage.getItem('selected_profile') || 'Myself'
        });

        // ALSO RENDER SCHEDULE
        renderSchedule(medicines);
        {% endif %}
        });

        // Robust Voice Loading Logic
        let allVoices = [];
        function loadVoices() {
            allVoices = speechSynthesis.getVoices();
        }
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices(); // Init immediately in case already loaded

        function getVoiceForLang(langCode) {
            if (allVoices.length === 0) loadVoices(); // Try again

            // 1. Try exact match + strict region (e.g., 'hi-IN' + 'Google')
            let voice = allVoices.find(v => v.lang === langCode && (v.name.includes('Google') || v.name.includes('India')));

            // 2. Try just language code match
            if (!voice) voice = allVoices.find(v => v.lang === langCode);

            // 3. Fallback for Indian context: Try to find ANY Indian English or Hindi voice if target is local
            if (!voice && (langCode === 'en-IN' || langCode === 'hi-IN' || langCode === 'kn-IN')) {
                voice = allVoices.find(v => v.lang === 'en-IN' || v.lang === 'hi-IN');
            }

            return voice;
        }
    </script>

    <!-- ===== VOICE COPILOT ===== -->

    <!-- Prominent Voice Bar (research says voice must be prominent for rural users) -->
    <button id="voice-fab" onclick="openVoiceChat()" class="voice-bar" style="
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999;
        border-radius: 0; margin: 0;
    ">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
            <line x1="12" y1="19" x2="12" y2="23" />
            <line x1="8" y1="23" x2="16" y2="23" />
        </svg>
        {{ texts.chat_title or 'Ask about your medicines' }}
    </button>

    <!-- Chat Overlay -->
    <div id="voice-chat-overlay" style="
        display: none; position: fixed; bottom: 0; left: 0; right: 0; top: 0;
        z-index: 10000; background: rgba(0,0,0,0.5);
        justify-content: center; align-items: flex-end;
    " onclick="if(event.target===this) closeVoiceChat()">
        <div id="voice-chat-panel" style="
            width: 100%; max-width: 500px; max-height: 85vh;
            background: white; border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        ">
            <!-- Chat Header -->
            <div style="
                background: var(--accent);
                color: white; padding: 18px 20px;
                display: flex; justify-content: space-between; align-items: center;
            ">
                <div>
                    <div style="font-weight: 800; font-size: 1.1rem;">{{ texts.chat_title or 'Medicine Assistant' }}
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">{{ texts.chat_subtitle or 'Ask about your medicines'
                        }}</div>
                </div>
                <button onclick="closeVoiceChat()" style="
                    background: none; border: none; color: white;
                    font-size: 1.5rem; cursor: pointer;
                ">‚úï</button>
            </div>

            <!-- Chat Messages -->
            <div id="voice-chat-messages" style="
                flex: 1; overflow-y: auto; padding: 20px;
                display: flex; flex-direction: column; gap: 12px;
                min-height: 200px; max-height: 50vh;
                background: #f8f9fa;
            ">
                <!-- Welcome Message -->
                <div class="chat-bubble ai-bubble">
                    {{ texts.chat_welcome or 'Hello! üëã Ask me anything about your medicines. Tap the mic to speak!' }}
                </div>
            </div>

            <!-- Input Area -->
            <div style="
                padding: 15px 20px; border-top: 1px solid #eee;
                display: flex; gap: 10px; align-items: center;
                background: white;
            ">
                <input id="voice-text-input" type="text"
                    placeholder="{{ texts.chat_placeholder or 'Type or tap mic...' }}" style="
                        flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb;
                        border-radius: 25px; font-size: 1rem; outline: none;
                        transition: border-color 0.2s;
                    " onkeydown="if(event.key==='Enter') sendTextQuestion()"
                    onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='#e5e7eb'">
                <!-- Mic Button -->
                <button id="voice-mic-btn" onclick="toggleListening()" style="
                    width: 48px; height: 48px; border-radius: 50%;
                    background: var(--accent);
                    border: none; color: white;
                    cursor: pointer; flex-shrink: 0;
                    transition: transform 0.2s, background 0.2s;
                    display: flex; align-items: center; justify-content: center;
                "><svg id="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                        <line x1="12" y1="19" x2="12" y2="23" />
                        <line x1="8" y1="23" x2="16" y2="23" />
                    </svg></button>
                <!-- Send Button -->
                <button onclick="sendTextQuestion()" style="
                    width: 48px; height: 48px; border-radius: 50%;
                    background: var(--secondary); border: none; color: white;
                    cursor: pointer; flex-shrink: 0;
                    display: flex; align-items: center; justify-content: center;
                "><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13" />
                        <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg></button>
            </div>
        </div>
    </div>

    <style>
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .ai-bubble {
            background: white;
            color: #1f2937;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .user-bubble {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .thinking-bubble {
            background: white;
            color: #9ca3af;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        #voice-mic-btn.listening {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            animation: pulse-mic 1s infinite;
        }

        @keyframes pulse-mic {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }
        }

        #voice-fab {
            /* already styled via .voice-bar class */
        }
    </style>

    <script>
        // ===== VOICE COPILOT LOGIC =====

        // Language codes for Web Speech API
        const SPEECH_LANG_MAP = {
            'English': 'en-IN',
            'Hindi': 'hi-IN',
            'Tamil': 'ta-IN',
            'Telugu': 'te-IN',
            'Kannada': 'kn-IN',
            'Malayalam': 'ml-IN'
        };

        let recognition = null;
        let isListening = false;
        const USER_LANG = '{{ language or "English" }}';

        // Show the FAB when results or history exists
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-render history in tab
            if (typeof renderHistoryInline === 'function') renderHistoryInline();
        });

        function openVoiceChat() {
            document.getElementById('voice-chat-overlay').style.display = 'flex';
        }

        function closeVoiceChat() {
            document.getElementById('voice-chat-overlay').style.display = 'none';
            stopSpeech();
            if (isListening && recognition) recognition.stop();
        }

        function addChatBubble(text, type) {
            const container = document.getElementById('voice-chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}-bubble`;
            bubble.textContent = text;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
            return bubble;
        }

        function removeBubble(bubble) {
            if (bubble && bubble.parentNode) bubble.parentNode.removeChild(bubble);
        }

        function toggleListening() {
            if (isListening) {
                if (recognition) recognition.stop();
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                addChatBubble('Speech recognition is not supported in your browser. Please use Chrome.', 'ai');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = SPEECH_LANG_MAP[USER_LANG] || 'en-IN';
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.maxAlternatives = 5;

            const micBtn = document.getElementById('voice-mic-btn');
            micBtn.classList.add('listening');
            micBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="12" height="16" rx="2" ry="2"/></svg>';
            isListening = true;

            // Add listening indicator
            const listeningBubble = addChatBubble('Listening...', 'thinking');

            recognition.onresult = (event) => {
                // Pick the result with highest confidence
                let bestTranscript = '';
                let bestConfidence = 0;
                for (let i = 0; i < event.results[0].length; i++) {
                    if (event.results[0][i].confidence > bestConfidence) {
                        bestConfidence = event.results[0][i].confidence;
                        bestTranscript = event.results[0][i].transcript;
                    }
                }
                if (!bestTranscript) bestTranscript = event.results[0][0].transcript;
                removeBubble(listeningBubble);
                processQuestion(bestTranscript);
            };

            recognition.onerror = (event) => {
                removeBubble(listeningBubble);
                if (event.error !== 'aborted') {
                    addChatBubble('Could not hear you clearly. Please try again.', 'ai');
                }
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
                micBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
                isListening = false;
            };

            recognition.start();
        }

        function sendTextQuestion() {
            const input = document.getElementById('voice-text-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            processQuestion(text);
        }

        function getMedicineContext() {
            // Try current results first
            {% if translated or english %}
            const currentMeds = {{ (translated or english) | tojson
        }};
        if (currentMeds && currentMeds.length > 0) return currentMeds;
        {% endif %}

        // Fall back to saved view or latest history
        if (window._savedViewMeds && window._savedViewMeds.length > 0) return window._savedViewMeds;

        const history = JSON.parse(localStorage.getItem('prescription_history') || '[]');
        if (history.length > 0) return history[0].medicines;

        return [];
        }

        async function processQuestion(questionText) {
            // Show user bubble
            addChatBubble(questionText, 'user');

            // Show thinking
            const thinkingBubble = addChatBubble('ü§î Thinking...', 'thinking');

            const medicines = getMedicineContext();

            try {
                const resp = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: questionText,
                        medicines: medicines,
                        language: USER_LANG
                    })
                });

                const data = await resp.json();
                removeBubble(thinkingBubble);

                // Show AI answer
                addChatBubble(data.answer, 'ai');

                // Read it aloud
                speakText(data.answer);
            } catch (err) {
                removeBubble(thinkingBubble);
                addChatBubble('Sorry, something went wrong. Please try again.', 'ai');
            }
        }

        let _chatAudio = null; // Track current chat audio playback

        async function speakText(text) {
            stopSpeech();
            try {
                const resp = await fetch('/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, language: USER_LANG })
                });
                const data = await resp.json();
                if (data.audio_url) {
                    _chatAudio = new Audio(data.audio_url);
                    _chatAudio.play();
                }
            } catch (err) {
                console.log('TTS error, falling back to browser speech:', err);
                // Fallback to browser speech if server fails
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = SPEECH_LANG_MAP[USER_LANG] || 'en-IN';
                utterance.rate = 0.85;
                speechSynthesis.speak(utterance);
            }
        }

        // Removed duplicate stopSpeech() - merged with the main one above
    </script>

</body>

</html>